---
title: "Walkability Perception"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    # orientation: columns
    # vertical_layout: 
    theme: 
      version: 4
      # bootswatch: sandstone
      navbar-bg: "#5B3069"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(reactable)
library(plotly)


# Loads all the files where functions are defined
files <- list.files(path = here::here("R"), pattern = "*.R", full.names = TRUE,
                    recursive = FALSE)
for (i in files) {
  source(i)
}

df <- data_preparations("data/raw/survey_autogenerated.csv")

ratings_df <- get_image_ratings(df) 

```


# Overview

## Column

### Participants {.value-box .no-mobile}

```{r}

valueBox(value = format(nrow(df), big.mark = ","), 
         caption = "participants have fully completed this survey", 
         icon = "fas fa-users", 
         color = "#E7E6F7")
```

### Images {.value-box .no-mobile}

```{r}

valueBox(value = format(nlevels(as.factor(ratings_df$image_num)), big.mark = ","), 
         caption = "different images have been assessed, of a total of 5,375", 
         icon = "fas fa-images", 
         color = "#E7E6F7")
```

## Column {.tabset}

### Demographics here

### Number of assessments per image

```{r}
ratings_df %>% 
  count(image_num, name ="Number of assessments") %>% 
  mutate(img = paste0("<a href='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/",image_num, "_composite.jpg'>",
      "<img src='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/", image_num, "_composite.jpg' width='260px'> </a>")) %>% 
  relocate(img, .after = image_num) %>% 
  reactable( searchable = TRUE, pagination = FALSE, columns = list(
    img = colDef(html = TRUE)
  ))
```

# Ratings

## Column {.tabset}

### Average ratings by genre

```{r}
ratings_avg <- df %>% 
  select(gender, starts_with(c("enjoyment_", "aesthetics_", "safety_", "vibrancy_"))) %>% 
  pivot_longer(!gender, names_to = "question", values_to = "answer") %>% 
  mutate(question = case_when(
    str_detect(question, "enjoyment_") ~ "enjoyment",
    str_detect(question, "aesthetics_") ~ "aesthetics",
    str_detect(question, "vibrancy_") ~ "vibrancy",
    str_detect(question, "safety_") ~ "safety"),
    answer = fct_relevel(answer, c("Strongly disagree", "Disagree", "Neither Agree or Disagree", "Agree", "Strongly Agree"))) %>% 
  count(gender, question, answer) %>% 
  arrange(gender, question, answer)

p <- ggplot(ratings_avg, aes(x = answer, y = n, fill = gender)) +
  geom_bar(position="dodge", stat="identity") +
  facet_grid(vars(question)) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Average ratings by question and gender",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    axis.line.x = element_blank(),
    strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
    legend.spacing.x = grid::unit(4.5, "pt"),
    legend.spacing.y = grid::unit(0, "pt"),
    legend.box.spacing = grid::unit(0, "cm")
  ) 
  
ggplotly(p) %>% 
  layout(legend = list(orientation = "h",   # show entries horizontally
                     xanchor = "center",  # use center of legend as anchor
                     x = 0.5)) 

# ggplot(ratings_avg, aes(x = answer, y = n)) +
#   # geom_density_line(
#   #   data = select(ratings_avg, -gender), aes(fill = "all respondents"),
#   #   color = "transparent"
#   # )  +
#   geom_col() +
#   facet_grid(vars(question), vars(gender)) +
#   scale_fill_brewer(palette = "Set1") +
#   theme_minimal() +
#   theme(
#     axis.line.x = element_blank(),
#     strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
#     legend.position = "bottom",
#     legend.justification = "right",
#     legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
#     legend.spacing.x = grid::unit(4.5, "pt"),
#     legend.spacing.y = grid::unit(0, "pt"),
#     legend.box.spacing = grid::unit(0, "cm")
#   )


```

### Combined ratings

```{r}
ratings_df %>% 
  count(image_num, item, rating) %>% 
  mutate(img = paste0("<a href='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/",image_num, "_composite.jpg'>",
      "<img src='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/", image_num, "_composite.jpg' width='100px'> </a>")) %>% 
  relocate(img, .after = image_num) %>% 
  arrange(item, rating) %>% 
  pivot_wider(names_from =c(item, rating), values_from = n) %>% 
  arrange(image_num) %>% 
  reactable(
    searchable = TRUE, 
    # pagination = FALSE, 
    # defaultSorted = list("Strongly Agree" = "desc"),
    defaultColDef = colDef(sortNALast = TRUE), 
    columns = list(
    img = colDef(html = TRUE)
  ))
```

### Aesthetics

```{r}
get_ratings_table(ratings_df, "aesthetics")

```

### Enjoyment

```{r}
get_ratings_table(ratings_df, "enjoyment")

```
### Safety

```{r}
get_ratings_table(ratings_df, "safety")

```

### Vibrancy

```{r}
get_ratings_table(ratings_df, "vibrancy")

```


# About {data-icon="ion-information-circled"}

### About 
```{r}
htmltools::includeMarkdown(here::here("README.md"))
```

