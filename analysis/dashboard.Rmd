---
title: "Walkability Perception"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    # orientation: columns
    # vertical_layout: 
    theme: 
      version: 5
      # bootswatch: pulse
      navbar-bg: "#5B3069"
      primary: "#5B3069"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(forcats)
library(ggplot2)
library(readr)
library(reactable)
library(stringr)
library(tidyr)
library(plotly)


# Loads all the files where functions are defined
files <- list.files(path = here::here("R"), pattern = "*.R", full.names = TRUE,
                    recursive = FALSE)
for (i in files) {
  source(i)
}

# df <- data_preparations("data/raw/survey_autogenerated.csv")
df <- data_preparations("data/raw/survey_2021-12-10.csv") %>% 
  select(!starts_with("timing_"))

ratings_df <- get_image_ratings(df) 

# Color definitions ------------------------------------------

warwick_color <- "#5B3069"
Warwick_color_disabled <- "#E7E6F7"

# Check this palette: https://bootswatch.com/pulse/

primary_disabled <- "#9278BA"
secondary_disabled <- "#DFDFDF"


# thematic::thematic_rmd()

```


# Demographics

```{r include=FALSE}

total_participants <- nrow(df)

participants <- df %>% 
  count(gender)

participants_female <- participants$n[participants$gender == "Female"]
participants_male <- participants$n[participants$gender == "Male"]
participants_non_binary <- participants$n[participants$gender == "Non-binary"]
participants_other <- participants$n[participants$gender == "Prefer to self-describe"]

participants_female_ratio <- round(
  participants_female / total_participants * 100, 1)

```


## Column

### Participants {.value-box .no-mobile}

```{r}

valueBox(value = format(nrow(df), big.mark = ","), 
         caption = "participants have fully completed this survey", 
         icon = "fas fa-users", 
         color = "#F8F8F8")
```

### Female {.value-box .no-mobile}

```{r}

valueBox(value = participants_female, 
         caption = "female participants", 
         icon = "fas fa-images", 
         color = "#F8F8F8")
```

### Male {.value-box .no-mobile}

```{r}

valueBox(value = participants_male, 
         caption = "male participants",
         color = "#F8F8F8")
```

### Non-binary {.value-box .no-mobile}

```{r}

valueBox(value = participants_non_binary, 
         caption = "non-binary participants", 
         icon = "fas fa-images", 
         color = "#F8F8F8")
```

### Other {.value-box .no-mobile}

```{r}

valueBox(value = participants_other, 
         caption = "participants prefered to self-describe themselves", 
         icon = "fas fa-images", 
         color = "#F8F8F8")
```

## Column {.tabset}

### Demographics' distribution

```{r}
demographics_df <- df %>% 
  select(gender, age) %>% 
  count(gender, age) %>% 
  arrange(gender, age) 

p <- ggplot(demographics_df, aes(x = age, y = n, fill = gender)) +
  geom_bar(position="dodge", stat="identity") +
  facet_grid(vars(gender)) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Demographics' distribution",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    axis.line.x = element_blank(),
    strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
    legend.spacing.x = grid::unit(4.5, "pt"),
    legend.spacing.y = grid::unit(0, "pt"),
    legend.box.spacing = grid::unit(0, "cm")
  ) 
  
ggplotly(p) %>% 
  layout(legend = list(orientation = "h",   # show entries horizontally
                     xanchor = "center",  # use center of legend as anchor
                     x = 0.5)) 

```


### Demographics' distribution2

```{r}
demographics_df <- df %>% 
  select(gender, age) %>% 
  count(gender, age) %>% 
  arrange(gender, age) 

p <- ggplot(demographics_df, aes(x = age, y = n, fill = gender)) +
  geom_bar(position="dodge", stat="identity") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Demographics' distribution",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    axis.line.x = element_blank(),
    strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
    legend.spacing.x = grid::unit(4.5, "pt"),
    legend.spacing.y = grid::unit(0, "pt"),
    legend.box.spacing = grid::unit(0, "cm")
  ) 
  
ggplotly(p) %>% 
  layout(legend = list(orientation = "h",   # show entries horizontally
                     xanchor = "center",  # use center of legend as anchor
                     x = 0.5)) 

```

### Table

```{r}

reactable(demographics_df)
```


# Ratings

## Column

### Participants {.value-box .no-mobile}

```{r}

valueBox(value = format(nrow(df), big.mark = ","), 
         caption = "participants have fully completed this survey", 
         icon = "fas fa-users", 
         color = "#F8F8F8")
```

### Images {.value-box .no-mobile}

```{r}

valueBox(value = format(nlevels(as.factor(ratings_df$image_num)), big.mark = ","), 
         caption = "different images have been assessed, of a total of 5,375", 
         icon = "fas fa-images", 
         color = "#F8F8F8")
```


## Column {.tabset}

### Average ratings by genre

```{r}
ratings_avg <- df %>% 
  select(gender, starts_with(c("enjoyment_", "aesthetics_", "safety_", "vibrancy_"))) %>% 
  pivot_longer(!gender, names_to = "question", values_to = "answer") %>% 
  mutate(question = case_when(
    str_detect(question, "enjoyment_") ~ "enjoyment",
    str_detect(question, "aesthetics_") ~ "aesthetics",
    str_detect(question, "vibrancy_") ~ "vibrancy",
    str_detect(question, "safety_") ~ "safety"),
    answer = fct_relevel(answer, c("Strongly disagree", "Disagree", "Neither Agree or Disagree", "Agree", "Strongly Agree"))) %>% 
  count(gender, question, answer) %>% 
  arrange(gender, question, answer) %>% 
  filter(!is.na(answer))

p <- ggplot(ratings_avg, aes(x = answer, y = n, fill = gender)) +
  geom_bar(position="dodge", stat="identity") +
  facet_grid(vars(question)) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Average ratings by question and gender",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    axis.line.x = element_blank(),
    strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
    legend.spacing.x = grid::unit(4.5, "pt"),
    legend.spacing.y = grid::unit(0, "pt"),
    legend.box.spacing = grid::unit(0, "cm")
  ) 
  
ggplotly(p) %>% 
  layout(legend = list(orientation = "h",   # show entries horizontally
                     xanchor = "center",  # use center of legend as anchor
                     x = 0.5)) 

# ggplot(ratings_avg, aes(x = answer, y = n)) +
#   # geom_density_line(
#   #   data = select(ratings_avg, -gender), aes(fill = "all respondents"),
#   #   color = "transparent"
#   # )  +
#   geom_col() +
#   facet_grid(vars(question), vars(gender)) +
#   scale_fill_brewer(palette = "Set1") +
#   theme_minimal() +
#   theme(
#     axis.line.x = element_blank(),
#     strip.text = element_text(size = 14, margin = margin(0, 0, 0.2, 0, "cm")),
#     legend.position = "bottom",
#     legend.justification = "right",
#     legend.margin = margin(4.5, 0, 1.5, 0, "pt"),
#     legend.spacing.x = grid::unit(4.5, "pt"),
#     legend.spacing.y = grid::unit(0, "pt"),
#     legend.box.spacing = grid::unit(0, "cm")
#   )


```

### Combined ratings

```{r}
ratings_df %>% 
  count(image_num, item, rating) %>% 
  mutate(img = paste0("<a href='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/",image_num, "_composite.jpg'>",
      "<img src='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/s/", image_num, "_composite.jpg' width='100px'> </a>")) %>% 
  relocate(img, .after = image_num) %>% 
  arrange(item, rating) %>% 
  filter(!is.na(rating)) %>% 
  pivot_wider(names_from =c(item, rating), values_from = n) %>% 
  arrange(image_num) %>% 
  reactable(
    searchable = TRUE, 
    striped = TRUE,
    highlight = TRUE,
    bordered = TRUE,
    # pagination = FALSE, 
    # defaultSorted = list("Strongly Agree" = "desc"),
    defaultColDef = colDef(
      sortNALast = TRUE,
      align = "center"
      ), 
    columns = list(
      image_num = colDef(name = "#", width=30, align = "right"),
      img = colDef(html = TRUE),
      `aesthetics_Strongly disagree` = colDef(name = "Strongly Disagree"),
      `aesthetics_Disagree` = colDef(name = "Disagree"),
      `aesthetics_Neither Agree or Disagree` = 
        colDef(name = "Neither Agree or Disagree"),
      `aesthetics_Agree` =  colDef(name = "Agree"),
      `aesthetics_Strongly Agree` =  colDef(name = "Strongly Agree"),
      `enjoyment_Strongly disagree` = colDef(name = "Strongly Disagree"),
      `enjoyment_Disagree` = colDef(name = "Disagree"),
      `enjoyment_Neither Agree or Disagree` = 
        colDef(name = "Neither Agree or Disagree"),
      `enjoyment_Agree` =  colDef(name = "Agree"),
      `enjoyment_Strongly Agree` =  colDef(name = "Strongly Agree"),
      `safety_Strongly disagree` = colDef(name = "Strongly Disagree"),
      `safety_Disagree` = colDef(name = "Disagree"),
      `safety_Neither Agree or Disagree` = 
        colDef(name = "Neither Agree or Disagree"),
      `safety_Agree` =  colDef(name = "Agree"),
      `safety_Strongly Agree` =  colDef(name = "Strongly Agree"),
      `vibrancy_Strongly disagree` = colDef(name = "Strongly Disagree"),
      `vibrancy_Disagree` = colDef(name = "Disagree"),
      `vibrancy_Neither Agree or Disagree` = 
        colDef(name = "Neither Agree or Disagree"),
      `vibrancy_Agree` =  colDef(name = "Agree"),
      `vibrancy_Strongly Agree` =  colDef(name = "Strongly Agree")
      ),
    columnGroups = list(
      colGroup(name = "Aesthetics", 
               columns = c("aesthetics_Strongly disagree", 
                           "aesthetics_Disagree",
                           "aesthetics_Neither Agree or Disagree",
                           "aesthetics_Agree",
                           "aesthetics_Strongly Agree")),
      colGroup(name = "Enjoyment", 
               columns = c("enjoyment_Strongly disagree", 
                           "enjoyment_Disagree",
                           "enjoyment_Neither Agree or Disagree",
                           "enjoyment_Agree",
                           "enjoyment_Strongly Agree")),
      colGroup(name = "Safety", 
               columns = c("safety_Strongly disagree", 
                           "safety_Disagree",
                           "safety_Neither Agree or Disagree",
                           "safety_Agree",
                           "safety_Strongly Agree")),
      colGroup(name = "Vibrancy", 
               columns = c("vibrancy_Strongly disagree", 
                           "vibrancy_Disagree",
                           "vibrancy_Neither Agree or Disagree",
                           "vibrancy_Agree",
                           "vibrancy_Strongly Agree"))
      )
    )
```

### Aesthetics

```{r}
get_ratings_table(ratings_df, "aesthetics")

```

### Enjoyment

```{r}
get_ratings_table(ratings_df, "enjoyment")

```
### Safety

```{r}
get_ratings_table(ratings_df, "safety")

```

### Vibrancy

```{r}
get_ratings_table(ratings_df, "vibrancy")

```

### Number of assessments per image

```{r}
ratings_df %>% 
  count(image_num, name ="Number of assessments") %>% 
  mutate(img = paste0("<a href='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/",image_num, "_composite.jpg'>",
      "<img src='https://raw.githubusercontent.com/WarwickCIM/walkability_survey/gsv_images/img/s/", image_num, "_composite.jpg' width='260px'> </a>")) %>% 
  relocate(img, .after = image_num) %>% 
  reactable( searchable = TRUE, pagination = FALSE, columns = list(
    img = colDef(html = TRUE)
  ))
```
# Perceptions


## Column

### Participants {.value-box .no-mobile}

# About {data-icon="ion-information-circled"}

### About 
```{r}
htmltools::includeMarkdown(here::here("README.md"))
```

